function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    
    const row = [
      data.date || new Date().toISOString(),
      data.persianTime || formatDate(new Date()),
      data.paymentMethod || '',
      data.cny || 0,
      data.rateCNY || 0,
      data.usdtRateExchange || 0,
      data.dollarRateExchange || 0,
      data.dollarToUsdt || 0,
      data.commission || 0,
      data.receivedAmount || 0,
      data.baseRate || 0,
      data.tolerance || 0,
      data.finalRate || 0,
      data.competitorRate || 0,
      data.status || '',
      data.notes || ''
    ];
    
    sheet.appendRow(row);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Data saved successfully'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const action = e.parameter.action;
    
    if (action === 'getLastRecords') {
      const count = parseInt(e.parameter.count) || 5;
      const lastRow = sheet.getLastRow();
      const startRow = Math.max(2, lastRow - count + 1);
      const numRows = lastRow - startRow + 1;
      
      if (numRows > 0) {
        const records = sheet.getRange(startRow, 1, numRows, 16).getValues();
        
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          records: records.reverse()
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'No records found'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function formatDate(date) {
  return Utilities.formatDate(date, 'Asia/Tehran', 'yyyy-MM-dd HH:mm:ss');
}

function createHeaders() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const headers = [
    'Date',
    'Persian Time',
    'Payment Method',
    'CNY Amount',
    'Rate CNY',
    'USDT Rate Exchange',
    'Dollar Rate Exchange',
    'Dollar/USDT',
    'Commission',
    'Received Amount',
    'Base Rate',
    'Tolerance',
    'Final Rate',
    'Competitor Rate',
    'Status',
    'Notes'
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
  sheet.getRange(1, 1, 1, headers.length).setBackground('#667eea');
  sheet.getRange(1, 1, 1, headers.length).setFontColor('#ffffff');
  
  Logger.log('Headers created successfully!');
}
